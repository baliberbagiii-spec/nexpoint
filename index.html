<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NexPoint Agency</title>

  <meta name="description" content="Katalog properti NexPoint Agency — Tanah Kavling dan Sewa">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23d4af37'/><path d='M16 6L6 14v12h8v-7h4v7h8V14L16 6z' fill='%23000'/></svg>">
  <link rel="stylesheet" href="styles.css">
</head>

<body>

<!-- ================= HEADER ================= -->
<header class="site-header">
  <div class="container header-inner">
    <!-- Hidden Google Translate - Auto Translate -->
    <div id="google_translate_element" style="display:none"></div>
    <div class="brand">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">
          <rect width="32" height="32" rx="6" fill="#d4af37"/>
          <path d="M16 6L6 14v12h8v-7h4v7h8V14L16 6z" fill="#000"/>
        </svg>
      </div>
      <div class="brand-text">
        <h1>NexPoint Agency</h1>
        <p class="tag">Temukan Investasi Properti Impian Anda</p>
      </div>
    </div>
    <div class="header-search">
      <input type="text" id="searchInput" class="search-input" placeholder="Cari tanah...">
    </div>
  </div>
</header>

<!-- ================= MAIN ================= -->
<main>

  <!-- HERO -->
  <section class="hero">
    <div class="container hero-inner">
      <div class="hero-text">
        <h2>Investasi Properti — <span class="accent">Mudah dan Aman</span></h2>
        <p class="lead">
          NexPoint Agency adalah agensi properti yang berfokus pada jasa jual–beli tanah di Bali, menghadirkan solusi profesional, transparan, dan tepat sasaran untuk kebutuhan investasi maupun pengembangan properti Anda.
        </p>
      </div>
    </div>
  </section>

  <!-- CATALOG -->
  <section id="catalog" class="catalog container">
    <h3 class="section-title">Katalog Properti</h3>
    <div id="cards" class="cards-grid"></div>
    <p id="noResults" class="no-results" style="display:none">Tidak ada properti yang ditemukan.</p>
  </section>

  <!-- CONTACT -->
  <section class="contacts container">
    <h2 class="section-title">Hubungi Kami</h2>
    <p class="contact-desc">Hubungi kami untuk mendapatkan informasi lebih lanjut tentang properti yang Anda minati.</p>
    <div id="contactsGrid" class="contacts-grid"></div>
  </section>

</main>

<!-- ================= FOOTER ================= -->
<footer class="site-footer">
  <div class="container footer-inner">
    <div>© <span id="year"></span> NexPoint Agency</div>
    <div class="footer-info">
      <div class="footer-address">Jl. Buluh Indah No.58, Pemecutan Kaja, Kec. Denpasar Utara, Kota Denpasar, Bali 80118</div>
      <div class="footer-hours">Jam Kerja: 08.00 WITA - 17.00 WITA</div>
    </div>
  </div>
</footer>

<!-- ================= ANALYTICS TRACKING ================= -->
<script>
// Track visitor analytics with IP
(function() {
  try {
    const analyticsKey = 'nexpoint_analytics';
    let analytics = JSON.parse(localStorage.getItem(analyticsKey) || '[]');
    
    // Get visitor info
    const visitorData = {
      page: 'index.html',
      timestamp: new Date().toISOString(),
      referrer: document.referrer || 'direct',
      language: navigator.language || navigator.userLanguage || 'unknown',
      userAgent: navigator.userAgent || 'unknown',
      screenWidth: window.screen.width,
      platform: navigator.platform || 'unknown',
      ip: null
    };
    
    // Fetch IP and store analytics
    fetch('https://api.ipify.org?format=json')
      .then(response => response.json())
      .then(data => {
        visitorData.ip = data.ip;
        // Check if it's after midnight WITA (UTC+8)
        const now = new Date();
        const witOffset = 8 * 60 * 60 * 1000; // WITA is UTC+8
        const witTime = new Date(now.getTime() + witOffset);
        const lastMidnight = new Date(witTime);
        lastMidnight.setHours(0, 0, 0, 0);
        
        visitorData.witaDate = lastMidnight.toISOString().split('T')[0];
        visitorData.logFileName = 'log_' + lastMidnight.toISOString().split('T')[0].replace(/-/g, '_') + '.txt';
        
        // Add to analytics array (keep last 1000 visits)
        analytics.push(visitorData);
        if (analytics.length > 1000) {
          analytics = analytics.slice(-1000);
        }
        
        localStorage.setItem(analyticsKey, JSON.stringify(analytics));
        
        // Store in daily log
        const logKey = 'nexpoint_daily_log_' + visitorData.logFileName;
        let dailyLog = JSON.parse(localStorage.getItem(logKey) || '[]');
        dailyLog.push(visitorData);
        localStorage.setItem(logKey, JSON.stringify(dailyLog));
      })
      .catch(err => {
        // Still save without IP
        analytics.push(visitorData);
        if (analytics.length > 1000) {
          analytics = analytics.slice(-1000);
        }
        localStorage.setItem(analyticsKey, JSON.stringify(analytics));
      });
  } catch (e) {
    console.log('Analytics tracking error:', e);
  }
})();
</script>

<!-- ================= SCRIPT ================= -->
<script>
// Check if accessed from valid page
(function() {
  const validPages = ['index.html', 'detail.html', 'admin.html', '404.html', ''];
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Allow access if coming from a valid page or direct file access
  const referrer = document.referrer;
  const isDirectAccess = referrer === '' || referrer.includes(window.location.host);
  
  // Check if current page is not in the allowed list
  if (!validPages.includes(currentPage) && !currentPage.startsWith('detail.html')) {
    // For direct access to unknown pages, redirect to 404
    if (isDirectAccess && currentPage !== 'index.html') {
      window.location.href = '404.html';
    }
  }
})();

const cardsContainer = document.getElementById('cards');
const searchInput = document.getElementById('searchInput');
const noResults = document.getElementById('noResults');
let allProperties = [];

// Load from localStorage first (admin updates), then from JSON file
async function loadProperties() {
  // First try localStorage (admin updates)
  const stored = localStorage.getItem('nexpoint_properties');
  if (stored) {
    try {
      const localProperties = JSON.parse(stored);
      if (localProperties.length > 0) {
        allProperties = localProperties;
        renderProperties(allProperties);
        return;
      }
    } catch (e) {
      console.log('Could not parse localStorage');
    }
  }
  
  // Fallback to JSON file
  try {
    const res = await fetch('properties.json');
    const properties = await res.json();
    allProperties = properties;
    renderProperties(allProperties);
  } catch (err) {
    console.error('Error loading properties:', err);
    cardsContainer.innerHTML = '<p class="error">Gagal memuat data.</p>';
  }
}

function renderProperties(properties) {
  if (properties.length === 0) {
    cardsContainer.innerHTML = '';
    noResults.style.display = 'block';
    return;
  }
  
  noResults.style.display = 'none';
  cardsContainer.innerHTML = properties.map(p => {
    // Combine land_type and title for display
    const displayTitle = p.land_type && p.title 
      ? p.land_type + ' - ' + p.title 
      : p.title || p.land_type || 'Properti';
    
    return `
    <article class="card">
      <a href="detail.html?id=${p.id}" class="card-media">
        <img src="${p.image}" alt="${displayTitle}">
      </a>
      <div class="card-body">
        <h4 class="card-title">
          <a href="detail.html?id=${p.id}" style="color:inherit;text-decoration:none">
            ${displayTitle}
          </a>
        </h4>
        <p class="card-desc">${p.short}</p>
        <div class="card-price">${p.price}${p.size_unit || ''}</div>
      </div>
    </article>
  `}).join('');
}

function searchProperties(query) {
  const searchTerm = query.toLowerCase().trim();
  
  if (!searchTerm) {
    renderProperties(allProperties);
    return;
  }
  
  const filtered = allProperties.filter(p => {
    const displayTitle = p.land_type && p.title 
      ? p.land_type + ' ' + p.title 
      : p.title || p.land_type || '';
    return displayTitle.toLowerCase().includes(searchTerm) ||
           (p.short && p.short.toLowerCase().includes(searchTerm)) ||
           (p.location && p.location.toLowerCase().includes(searchTerm)) ||
           p.price.toLowerCase().includes(searchTerm);
  });
  
  renderProperties(filtered);
}

searchInput.addEventListener('input', (e) => {
  searchProperties(e.target.value);
});

// Listen for storage changes (admin updates from other tabs)
window.addEventListener('storage', (e) => {
  if (e.key === 'nexpoint_properties') {
    loadProperties();
  } else if (e.key === 'nexpoint_contacts') {
    loadContacts();
  }
});

// Also listen for same-tab updates via BroadcastChannel
const channel = new BroadcastChannel('nexpoint_updates');
channel.onmessage = (e) => {
  if (e.data.type === 'properties_updated') {
    loadProperties();
  } else if (e.data.type === 'contacts_updated') {
    loadContacts();
  }
};

document.getElementById('year').textContent = new Date().getFullYear();
loadProperties();

// Load contacts from localStorage first (admin updates), then from JSON file
const contactsGrid = document.getElementById('contactsGrid');

async function loadContacts() {
  // First try localStorage (admin updates)
  const stored = localStorage.getItem('nexpoint_contacts');
  if (stored) {
    try {
      const localContacts = JSON.parse(stored);
      if (localContacts && localContacts.length > 0) {
        renderContacts(localContacts);
        return;
      }
    } catch (e) {
      console.log('Could not parse localStorage contacts');
    }
  }
  
  // Fallback to JSON file
  try {
    const res = await fetch('contacts.json');
    const contacts = await res.json();
    renderContacts(contacts);
  } catch (err) {
    console.error('Error loading contacts:', err);
    contactsGrid.innerHTML = '<p class="error">Gagal memuat kontak.</p>';
  }
}

function renderContacts(contacts) {
  if (!contacts || contacts.length === 0) {
    contactsGrid.innerHTML = '';
    return;
  }
  
  contactsGrid.innerHTML = contacts.map(c => `
    <a href="https://wa.me/${c.phone}" target="_blank" class="contact-card contact-link">
      <div class="avatar">${c.initials || c.name.charAt(0)}</div>
      <div>
        <div class="name">${c.name}</div>
      </div>
    </a>
  `).join('');
}

loadContacts();
</script>
  
<!-- ================= GOOGLE TRANSLATE (HIDDEN - AUTO BY LOCATION) ================= -->
<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'id',
    includedLanguages: 'en,id,ms,zh-CN,ja,ko,ar',
    layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL,
    autoDisplay: false
  }, 'google_translate_element');
  
  // Auto translate based on user's language (hidden)
  setTimeout(function() {
    var select = document.querySelector('.goog-te-combo');
    if (select && select.value !== 'id') {
      select.dispatchEvent(new Event('change'));
    }
  }, 1500);
}
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>
